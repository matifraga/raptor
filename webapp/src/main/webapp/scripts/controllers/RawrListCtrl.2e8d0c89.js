define(["AnguRaptor","services/api","filters/htmlize","directives/rawr-composer"],function(a){a.controller("RawrListCtrl",["$scope","api","$interval",function(a,b,c){var d={selected:0,globalDisable:!0,items:[],loggedIn:b.user.isLoggedIn(),intervals:[]},e=function(a){d.intervals.push(c(function(){g(a)},a.interval))},f=function(){angular.forEach(d.intervals,function(a){c.cancel(a)})},g=function(a){var b=null;0===a.newRawrs.length&&0!==a.rawrs.length?b=a.rawrs[0].rerawr?a.rawrs[0].rerawr.created_time:a.rawrs[0].created_time:0!==a.rawrs.length&&(b=a.newRawrs[0].rerawr?a.newRawrs[0].rerawr.created_time:a.newRawrs[0].created_time),a.fetch(a.fetchLimit,null,b).then(function(b){0===a.rawrs.length?a.rawrs=b:a.newRawrs=b.concat(a.newRawrs)})},h=a.$watch("items",function(){f(),d.items=[],d.globalDisable=!0;for(var b=0;b<a.items.length;b++)d.items.push({index:b,rawrs:a.items[b].rawrs||[],newRawrs:[],busy:!1,max_position:null,fetchLimit:a.items[b].fetchLimit||15,fetch:a.items[b].nextPage,title:a.items[b].title,interval:a.items[b].interval,disabled:a.items[b].disabled||!1}),d.items[b].interval&&e(d.items[b]);d.items.length>0&&(d.globalDisable=!1)});d.fetchOld=function(){var a=d.items[d.selected];a.busy||a.disabled||(a.busy=!0,a.fetch(a.fetchLimit,a.max_position,null).then(function(b){b.length<a.fetchLimit&&(a.disabled=!0);for(var c=0;c<b.length;c++)a.rawrs.push(b[c]);var d=b[b.length-1];d&&(a.max_position=d.rerawr?d.rerawr.created_time:d.created_time),a.busy=!1})["catch"](function(){a.busy=!1,a.disabled=!0}))},d.showNew=function(){var a=d.items[d.selected];a.rawrs=a.newRawrs.concat(a.rawrs),a.newRawrs=[]},d.switchSelection=function(a){a!==d.selected&&(d.selected=a,0===d.items[a].rawrs.length&&d.fetchOld())},d.like=function(a){a.user_has_liked?(b.rawr.unlike(a.id),a.counts.likes--):(b.rawr.like(a.id),a.counts.likes++),a.user_has_liked=!a.user_has_liked},d.rerawr=function(a){a.user_has_rerawred?(b.rawr.unrerawr(a.id),a.counts.rerawrs--):(b.rawr.rerawr(a.id),a.counts.rerawrs++),a.user_has_rerawred=!a.user_has_rerawred},d.toggleReply=function(a){null==a.replyOpen||a.replyOpen===!1?a.replyOpen=!0:a.replyOpen=!1},d.postReply=function(a,c){d.toggleReply(c),b.rawr.create(a)},a.rawrList=d,a.$on("$destroy",h),a.$on("$destroy",f)}])});